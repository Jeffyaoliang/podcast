<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DreamEcho - æ’­å®¢</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
      color: #1a1a1a;
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      padding: 60px 24px 80px;
      position: relative;
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .header p {
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .status-badge {
      position: absolute;
      top: 20px;
      right: 24px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-badge.connected {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .status-badge.disconnected {
      background: rgba(239, 68, 68, 0.9);
    }
    
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      margin-top: -50px;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .search-input {
      flex: 1;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #6366f1;
    }
    
    .btn {
      padding: 14px 28px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      white-space: nowrap;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #e5e7eb;
      border-top: 3px solid #6366f1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .podcast-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
    }
    
    .podcast-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    
    .podcast-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    
    .podcast-cover-wrapper {
      position: relative;
      aspect-ratio: 1;
      overflow: hidden;
    }
    
    .podcast-cover {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }
    
    .podcast-card:hover .podcast-cover {
      transform: scale(1.05);
    }
    
    .podcast-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .podcast-card:hover .podcast-overlay {
      opacity: 1;
    }
    
    .play-icon {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6366f1;
    }
    
    .podcast-placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: #6366f1;
    }
    
    .podcast-info {
      padding: 14px;
    }
    
    .podcast-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 6px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .podcast-desc {
      font-size: 0.8rem;
      color: #6b7280;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .btn-detail {
      margin-top: 12px;
      width: 100%;
      padding: 10px;
      background: #f3f4f6;
      color: #374151;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .btn-detail:hover {
      background: #e5e7eb;
    }
    
    .episode-list {
      margin-top: 20px;
    }
    
    .episode-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    
    .episode-title {
      font-weight: 600;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    
    .episode-meta {
      display: flex;
      gap: 16px;
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 12px;
    }
    
    .episode-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    audio {
      width: 100%;
      border-radius: 8px;
      margin-top: 8px;
    }
    
    .error {
      background: #fef2f2;
      color: #dc2626;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .success {
      background: #f0fdf4;
      color: #16a34a;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .backend-info {
      background: #f0f9ff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #0369a1;
      margin-bottom: 16px;
      font-family: monospace;
    }
    
    .divider {
      height: 1px;
      background: #e5e7eb;
      margin: 24px 0;
    }
    
    .tag {
      display: inline-block;
      padding: 4px 10px;
      background: #e0e7ff;
      color: #4338ca;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-right: 8px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <div class="header">
    <div class="header-content">
      <h1>ğŸ™ï¸ DreamEcho</h1>
      <p>Go åç«¯ API æ¼”ç¤º</p>
    </div>
    <div id="statusBadge" class="status-badge disconnected">
      <span>ğŸ”´</span>
      <span id="statusText">æ­£åœ¨è¿æ¥...</span>
    </div>
  </div>
  
  <div class="main-container">
    <!-- çƒ­é—¨æ’­å®¢ -->
    <div class="card">
      <h2 class="section-title">ğŸ”¥ çƒ­é—¨æ’­å®¢</h2>
      <div class="backend-info">
        åç«¯åœ°å€: <span id="backendUrl">http://localhost:8080</span>
      </div>
      <div id="popularPodcasts" class="podcast-grid">
        <div class="loading"><span class="spinner"></span>åŠ è½½ä¸­...</div>
      </div>
    </div>
    
    <div class="divider"></div>
    
    <!-- æœç´¢ -->
    <div class="card">
      <h2 class="section-title">ğŸ” æœç´¢æ’­å®¢</h2>
      <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="è¾“å…¥æ’­å®¢åç§°ï¼Œå¦‚ï¼šå†…æ ¸ææ…Œã€Teahourã€æ—¥è°ˆå…¬å›­">
        <button class="btn" id="searchBtn" onclick="search()">æœç´¢</button>
      </div>
      <div id="searchResults"></div>
    </div>
    
    <div class="divider"></div>
    
    <!-- è§£æ RSS -->
    <div class="card">
      <h2 class="section-title">ğŸ“» è§£ææ’­å®¢ RSS</h2>
      <div class="search-box">
        <input type="text" class="search-input" id="rssInput" placeholder="è¾“å…¥ RSS URLï¼Œå¦‚ï¼šhttps://pan.icu/feed">
        <button class="btn" id="parseBtn" onclick="parseRSS()">è§£æ</button>
      </div>
      <div id="parseResults"></div>
    </div>
  </div>

  <script>
    // é…ç½®
    const BACKEND_URL = 'http://localhost:8080';
    
    // çƒ­é—¨æ’­å®¢åˆ—è¡¨
    const POPULAR_FEEDS = [
      { title: 'å†…æ ¸ææ…Œ', rssUrl: 'https://pan.icu/feed', description: 'ä¸€æ¡£å·ç§°ç¡¬æ ¸å´æ²¡ä»€ä¹ˆå¹²è´§çš„ä¿¡æ¯æŠ€æœ¯ä¸»é¢˜å¨±ä¹èŠ‚ç›®' },
      { title: 'Teahour', rssUrl: 'https://feeds.fireside.fm/teahour/rss', description: 'èšç„¦äºç¨‹åºã€åˆ›ä¸šä»¥åŠä¸€åˆ‡ Geek è¯é¢˜çš„ä¸­æ–‡æ’­å®¢' },
      { title: 'æ—¥è°ˆå…¬å›­', rssUrl: 'https://www.rituantan.com/feed', description: 'å¸Œæœ›å¯ä»¥ä¸ºå¬ä¼—æœ‹å‹ä»¬æä¾›ç»ä½³çš„æ”¶å¬ä½“éªŒ' },
      { title: 'æ•…äº‹FM', rssUrl: 'https://storyfm.cn/feed', description: 'æ¯ä¸ªäººéƒ½å¯ä»¥æˆä¸ºä¸»è§’' },
      { title: 'åšç‰©å¿—', rssUrl: 'https://bowuzhi.fm/feed', description: 'ä¸€æ¡£å…³äºåšç‰©é¦†ã€è‰ºæœ¯ã€ç§‘æŠ€ã€è‡ªç„¶çš„æ³›æ–‡åŒ–æ’­å®¢' },
      { title: 'ç–¯æŠ•åœˆ', rssUrl: 'https://zhubi.app/feed/3XFKy8', description: 'ä¸€æ¡£å…³äºåˆ›ä¸šæŠ•èµ„çš„æ’­å®¢' },
    ];
    
    // è·å–æ’­å®¢é¦–å­—æ¯ä½œä¸ºå ä½ç¬¦
    function getFirstChar(title) {
      return title.charAt(0).toUpperCase();
    }
    
    // è·å–å ä½å›¾
    function getPlaceholder(title, bgColor = 'e0e7ff') {
      return `https://ui-avatars.com/api/?name=${encodeURIComponent(title)}&background=${bgColor}&color=4338ca&size=200&bold=true&font-size=0.4&length=2`;
    }
    
    // æ£€æŸ¥åç«¯è¿æ¥
    async function checkBackend() {
      const statusBadge = document.getElementById('statusBadge');
      const statusText = document.getElementById('statusText');
      const backendUrlEl = document.getElementById('backendUrl');
      
      backendUrlEl.textContent = BACKEND_URL;
      
      try {
        // å°è¯•è°ƒç”¨ feed API ä½œä¸ºæµ‹è¯•
        const testUrl = 'https://pan.icu/feed';
        const response = await fetch(`${BACKEND_URL}/api/feed?url=${encodeURIComponent(testUrl)}`);
        
        if (response.ok) {
          statusBadge.className = 'status-badge connected';
          statusBadge.innerHTML = '<span>ğŸŸ¢</span><span>åç«¯å·²è¿æ¥</span>';
          return true;
        }
      } catch (error) {
        console.log('è¿æ¥å¤±è´¥:', error);
      }
      
      statusBadge.className = 'status-badge disconnected';
      statusBadge.innerHTML = '<span>ğŸ”´</span><span>åç«¯æœªè¿æ¥</span>';
      return false;
    }
    
    // åŠ è½½çƒ­é—¨æ’­å®¢
    async function loadPopularPodcasts() {
      const container = document.getElementById('popularPodcasts');
      
      container.innerHTML = POPULAR_FEEDS.map(feed => `
        <div class="podcast-card" onclick="loadPodcast('${encodeURIComponent(feed.rssUrl)}', '${encodeURIComponent(feed.title)}')">
          <div class="podcast-cover-wrapper">
            <div class="podcast-placeholder">${getFirstChar(feed.title)}</div>
            <div class="podcast-overlay">
              <div class="play-icon">â–¶</div>
            </div>
          </div>
          <div class="podcast-info">
            <div class="podcast-title">${feed.title}</div>
            <div class="podcast-desc">${feed.description}</div>
            <button class="btn-detail">æŸ¥çœ‹è¯¦æƒ…</button>
          </div>
        </div>
      `).join('');
    }
    
    // åŠ è½½æ’­å®¢è¯¦æƒ…
    async function loadPodcast(rssUrl, title) {
      const parseResults = document.getElementById('parseResults');
      parseResults.innerHTML = '<div class="loading"><span class="spinner"></span>åŠ è½½ä¸­...</div>';
      
      // å¡«å…… RSS URL
      document.getElementById('rssInput').value = decodeURIComponent(rssUrl);
      
      // æ»šåŠ¨åˆ°è§£æåŒºåŸŸ
      parseResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      await parseRSS();
    }
    
    // æœç´¢æ’­å®¢
    async function search() {
      const keyword = document.getElementById('searchInput').value.trim();
      const resultsEl = document.getElementById('searchResults');
      const searchBtn = document.getElementById('searchBtn');
      
      if (!keyword) {
        resultsEl.innerHTML = '<div class="error">è¯·è¾“å…¥æœç´¢å…³é”®è¯</div>';
        return;
      }
      
      searchBtn.disabled = true;
      searchBtn.innerHTML = '<span class="spinner"></span>æœç´¢ä¸­...';
      resultsEl.innerHTML = '<div class="loading"><span class="spinner"></span>æ­£åœ¨æœç´¢...</div>';
      
      try {
        const response = await fetch(`${BACKEND_URL}/api/feed?url=${encodeURIComponent(keyword)}`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        resultsEl.innerHTML = `
          <div class="success">âœ… æ‰¾åˆ°æ’­å®¢: ${data.title}</div>
          <div class="podcast-grid">
            <div class="podcast-card" onclick="showEpisodes('${encodeURIComponent(keyword)}')">
              <div class="podcast-cover-wrapper">
                <img class="podcast-cover" src="${data.image || getPlaceholder(data.title)}" 
                     onerror="this.parentElement.innerHTML='<div class=\\'podcast-placeholder\\'>${getFirstChar(data.title)}</div>'">
                <div class="podcast-overlay">
                  <div class="play-icon">â–¶</div>
                </div>
              </div>
              <div class="podcast-info">
                <div class="podcast-title">${data.title}</div>
                <div class="podcast-desc">${data.description || 'æš‚æ— æè¿°'}</div>
                <button class="btn-detail">æŸ¥çœ‹ ${data.episodes?.length || 0} é›†</button>
              </div>
            </div>
          </div>
          <div class="episode-list" id="episodeList"></div>
        `;
      } catch (error) {
        resultsEl.innerHTML = `<div class="error">âŒ ${error.message}</div>`;
      } finally {
        searchBtn.disabled = false;
        searchBtn.innerHTML = 'æœç´¢';
      }
    }
    
    // æ˜¾ç¤ºå•é›†åˆ—è¡¨
    async function showEpisodes(rssUrl) {
      const url = decodeURIComponent(rssUrl);
      const episodeList = document.getElementById('episodeList');
      
      if (!url) {
        episodeList.innerHTML = '<div class="error">è¯·å…ˆè¾“å…¥ RSS URL</div>';
        return;
      }
      
      episodeList.innerHTML = '<div class="loading"><span class="spinner"></span>åŠ è½½å•é›†...</div>';
      
      // æ»šåŠ¨åˆ°å•é›†åŒºåŸŸ
      episodeList.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      try {
        const response = await fetch(`${BACKEND_URL}/api/feed?url=${encodeURIComponent(url)}`);
        const data = await response.json();
        
        if (data.episodes && data.episodes.length > 0) {
          episodeList.innerHTML = `
            <h4 style="margin-bottom: 16px;">ğŸ“° ${data.title} - å•é›†åˆ—è¡¨</h4>
            ${data.episodes.map((episode, index) => `
              <div class="episode-card">
                <div class="episode-title">${index + 1}. ${episode.title}</div>
                <div class="episode-meta">
                  <span>â±ï¸ ${episode.duration || 'æœªçŸ¥æ—¶é•¿'}</span>
                  <span>ğŸ“… ${episode.pubDate || 'æœªçŸ¥æ—¥æœŸ'}</span>
                </div>
                ${episode.audioUrl ? `
                  <audio controls>
                    <source src="http://localhost:8080/api/proxy/audio?url=${encodeURIComponent(episode.audioUrl)}" type="audio/mpeg">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                  </audio>
                  <p style="font-size: 0.75rem; color: #6b7280; margin-top: 8px;">
                    <a href="${episode.audioUrl}" target="_blank" style="color: #6366f1;">åŸå§‹é“¾æ¥</a>
                  </p>
                ` : '<p style="color: #dc2626; font-size: 0.9rem;">âš ï¸ æ— éŸ³é¢‘é“¾æ¥</p>'}
              </div>
            `).join('')}
          `;
        } else {
          episodeList.innerHTML = '<div class="error">æš‚æ— æ•°é›†</div>';
        }
      } catch (error) {
        episodeList.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // è§£æ RSS
    async function parseRSS() {
      const rssUrl = document.getElementById('rssInput').value.trim();
      const resultsEl = document.getElementById('parseResults');
      const parseBtn = document.getElementById('parseBtn');
      
      if (!rssUrl) {
        resultsEl.innerHTML = '<div class="error">è¯·è¾“å…¥ RSS URL</div>';
        return;
      }
      
      parseBtn.disabled = true;
      parseBtn.innerHTML = '<span class="spinner"></span>è§£æä¸­...';
      resultsEl.innerHTML = '<div class="loading"><span class="spinner"></span>æ­£åœ¨è§£æ...</div>';
      
      try {
        const response = await fetch(`${BACKEND_URL}/api/feed?url=${encodeURIComponent(rssUrl)}`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        resultsEl.innerHTML = `
          <div style="display: flex; gap: 20px; margin-bottom: 24px;">
            <img style="width: 120px; height: 120px; border-radius: 12px; object-fit: cover;" src="${data.image || getPlaceholder(data.title)}" 
                 onerror="this.style.display='none'">
            <div>
              <h3 style="font-size: 1.3rem; margin-bottom: 10px;">${data.title}</h3>
              <p style="color: #6b7280; font-size: 0.9rem; line-height: 1.6;">${data.description || 'æš‚æ— æè¿°'}</p>
              <div style="margin-top: 12px;">
                ${data.episodes?.slice(0, 3).map(e => `<span class="tag">${e.title.substring(0, 15)}...</span>`).join('') || ''}
              </div>
            </div>
          </div>
          
          <h4 style="margin-bottom: 16px;">ğŸ“° å…± ${data.episodes?.length || 0} é›†</h4>
          <div class="episode-list">
            ${data.episodes?.slice(0, 5).map((episode, index) => `
              <div class="episode-card">
                <div class="episode-title">${index + 1}. ${episode.title}</div>
                <div class="episode-meta">
                  <span>â±ï¸ ${episode.duration || 'æœªçŸ¥æ—¶é•¿'}</span>
                  <span>ğŸ“… ${episode.pubDate || 'æœªçŸ¥æ—¥æœŸ'}</span>
                </div>
                ${episode.audioUrl ? `
                  <audio controls>
                    <source src="http://localhost:8080/api/proxy/audio?url=${encodeURIComponent(episode.audioUrl)}" type="audio/mpeg">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                  </audio>
                ` : ''}
              </div>
            `).join('') || '<p>æš‚æ— æ•°é›†</p>'}
            ${data.episodes && data.episodes.length > 5 ? `
              <p style="text-align: center; color: #6b7280; margin-top: 16px;">
                è¿˜æœ‰ ${data.episodes.length - 5} é›†æœªæ˜¾ç¤º...
              </p>
            ` : ''}
          </div>
        `;
      } catch (error) {
        resultsEl.innerHTML = `<div class="error">âŒ ${error.message}</div>`;
      } finally {
        parseBtn.disabled = false;
        parseBtn.innerHTML = 'è§£æ';
      }
    }
    
    // åˆå§‹åŒ–
    window.onload = async () => {
      document.getElementById('backendUrl').textContent = BACKEND_URL;
      await checkBackend();
      loadPopularPodcasts();
    };
  </script>
</body>
</html>
